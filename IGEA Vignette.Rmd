---
title: "Instant Gas Exchange Analysis (IGEA) package"
output:
  # pdf_document:
  #   toc: yes
  html_document:
    toc: yes
    toc_float: yes
---

## Introduction

Photosythesis rate, water conductance and Ci/Ca (intercellular to ambient CO2 partial pressures) are three key plant physiological parameters in terms of carbon simulation and water use efficiency ( [Lawson and Blatt, 2014](http://www.plantphysiol.org/content/plantphysiol/164/4/1556.full.pdf); [Ellsworth and Cousins, 2016](http://www.sciencedirect.com/science/article/pii/S1369526616300632?via%3Dihub) ). In short, I will refer these three parameters as "gas exchange parameters"" in the following context. They can be measured simultaneously using LI-6400XT Portable Photosynthesis System [(LiCor Inc. Lincoln Nebraska, USA)](https://www.licor.com/env/products/photosynthesis/LI-6400XT/). The actual measurement procedure is relatively complex, but the short story is that you place the machine right next to the plant, clamp the leaf into the chamber, and initiate the autolog program. LI-6400XT records all the input parameters in time series and does the calculation to get those parameters that we care about.

This R package is designed specifically for experimental projects that are currently going on in [Leakey Lab (UIUC)](https://lab.igb.illinois.edu/leakey/home). Recently Postoc Dr. Wertin applied a high-throughtput protocol for gas exchange measurements in this summer field season. The major improvement of this protocol involves harvesting leaves in the field and then conducting measurements in lab instead of taking the machine out in the field to the plants. This newer method allows us to measure more than 200 leafs (single 4-minute measurement on each leaf) per day, attributing to the fact that people don't need to carry around the heavy machine in the field under harsh sunlight. After being harvested from field and take back to lab, each leaf is kept hydrated by inserting its cut wound side into a 10 ml tube full of water. Leaves are rotationally incubated for half an hour in two lighted growth chambers prior to measurements since it takes that long to activate each leaf and let them function happily. Recording leaf's identity into LI-6400XT is done by adding "remarks" of leaf identity between two measurements. This is a bit old fashioned and also is where a big part of human errors come from that need to be fixed. Measurements are taken place after clamping the leaf for 4 minutes. 

Example data provided in this tutorial is my real data collected in this summer. In order to better show the functions of my package as well as to have a reasonable data size, only a part of my dataset is provided here. My experimental design is a RCBD with 2 blocks. With in each block, each genotype has its plot and there are 2 biological sampled within each plot. Due to the fact that here is a partial dataset, total reps for most genotypes are less than 4. 

```{r include = FALSE}

source("~/GitHub/Instant-Gas-Exchange-Measurements/R/GXread.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/CS_GXcurve.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/GetValue_GXcurve.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/Find_GXcurve.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/plotGX.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/PGMean.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/summary_GXcurve.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/summary_GXvalue.R")
source("~/GitHub/Instant-Gas-Exchange-Measurements/R/summary_GXmean.R")

```


The aim of this package is to provide a pipeline of treating the standard output table from LI-6400XT. Measurements are first reformated, merged and screened to see abnormal measurements in ``read.GX`` and ``CS.GXcurve`` function. Then curves can be plotted so that outliers can be spotted and found, using ``plotGX`` and ``Find.GXcurve``. Values will be extracted from curves with function ``GetValue.GXcurve``. At last ``PGMean.GXvalue`` is used to calculate plot means and genotype means. ``summary.GXcurve``, ``summary.GXvalue``, ``summary.GXmean`` provide detailed information for corresponding class of data.



## read.GX

Once you copied the raw output table from LI-6400, turn it into csv file. My files have a naming convention of "Operator + date + population + machine .csv". These data are provided in *inst/extdata* folder. These data has a long header, lots of parameters, ton of useless time remarks and relatively complicated structure. In short, they desperately need to be re-structured and re-organized.

First we read them in. On each day we sample a whole set of replicates, thus, samples measured on 7-18 and 9-20 are leaf replicates 1 and samples measured on 7-19 and 7-21 are leaf replicates 2. ``genolist`` is a table listing all leaf identity remark names with corresponding genotype names so that ``read.GX`` can match and add genotype names for each measurement. After reading in, the output data has class of ``GXcurve``.

If argument ``condition`` is ``TRUE``, the measurement conditions will be checked and printed. Some machines doesn't record all the conditions (like this case below). Warnings will pop out when the file has multiple conditions or incomplete conditions. Check or not, ``GXcurve`` file will include as many conditions as it recorded in the attributes. 

```{r }
leak1_718 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/KX 07-18-2017 ril leak1_.csv",leaf_rep = 1,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv", condition = TRUE)
```

Notice in this dataset some name "remarks" have only 2 digits (operator's fault), which will cause trouble later. So all plot names have to unified into 3 digits. 

```{r}

getwd()


steward_718 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/TMW 07-18-2017 ril stewart_.csv",leaf_rep = 1,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
```

I omit the code of reading in the remaining csv files here. In total I read in 9 example dataset here: ``leak1_718``, ``leak2_718``, ``steward_718``, ``leak1_719``, ``leak1_720``, ``steward_720``, ``leak1_721``, ``leak2_721``, ``steward_721``

```{r include = FALSE}

leak2_718 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/KX 07-18-2017 RIL leak2_.csv",leaf_rep = 1,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
leak1_719 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/KX 07-19-2017 RIL_ leak1.csv",leaf_rep = 2,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
leak1_720 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/nicole-7-20-2017-ril_leak1.csv",leaf_rep = 1,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
steward_720 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/KX 07-20-2017 RIL_Stewart.csv",leaf_rep = 1,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
leak1_721 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/cm 07-21-2017 ril leak1_.csv",leaf_rep = 2,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
leak2_721 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/cm 07-21-2017 ril leak2_.csv",leaf_rep = 2,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
steward_721 = read.GX(filename = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/KX 07-21-2017 RIL STEWARD_.csv",leaf_rep = 2,genolist = "~/GitHub/Instant-Gas-Exchange-Measurements/inst/extdata/genotypic imformation.csv")
```

Let's take a look of the output.

```{r}
head(leak1_718)
str(leak1_718)
```


## CS_GXcurve

CS_GXcurve does the job of combining and screening. Combining means two seperate ``GXcurve`` tables are merged based on rows due to the fact data structures should be the same after being read in. Also measurement condition attributes are deleted. Since dataset usually has a huge size, it is a lot of work to go through each measurement and screen for abnormal ones. 

Screening part is the key to identify human errors made during measurements. It is impossible 
Dataset has a huge





## plotGX


## Find.GXcurve


## GetValue.GXcurve

There are two types of values we calculate and include in our further experiment (like correlations with other traits): First, we find the biggest "water conductance" value in the first minute and take the corresponding "Photosythesis" and "Ci/Ca" values; Second, we take the means of these three parameters in the last minute. Currently we don't know which set of values are better representative but we hope further analysis will tell us more. 



## PGMean.GXvalue


## summary





## example
```{r include = FALSE}
library(viridis)
```

The code below demonstrates two color palettes in the [viridis](https://github.com/sjmgarnier/viridis) package. Each plot displays a contour map of the Maunga Whau volcano in Auckland, New Zealand.

## Viridis colors

```{r}
image(volcano, col = viridis(200))
```

## Magma colors

```{r}
image(volcano, col = viridis(200, option = "A"))
```
